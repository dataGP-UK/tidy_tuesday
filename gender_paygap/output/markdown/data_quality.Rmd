---
title: "Gender Pay Gap - Review of Data Quality"
output: html_notebook
---

```{r set_up}
library(tidyverse)
library(here)

# import clean data
paygap <- read_rds(here('gender_paygap/data/processed/paygap_clean.rda'))
```

# Timeliness

Most public authority employers must use a snapshot date of 31 March. They must report and publish their gender pay gap information by 30 March of the following year

Private, voluntary, and all other public authority employers must use a snapshot date of 5 April. They must report and publish their gender pay gap information by 4 April of the following year.

```{r timeliness}
paygap %>% 
    summarise(min = min(delay),
              mean = mean(delay),
              median = median(delay),
              max = max(delay)) %>% 
    round(1) 

paygap %>% 
    ggplot(aes(delay)) +
    geom_histogram(bins = 30, ) +
    geom_vline(xintercept = - 366, 
               colour = 'red',
               linetype = 'dashed')

paygap %>% 
    ggplot(aes(delay)) +
    geom_boxplot(outlier.alpha = 0.1) +
    geom_vline(xintercept = - 366, 
               colour = 'red',
               linetype = 'dashed')

sum(paygap$late_submission)
round(mean(paygap$late_submission) * 100)

length(unique(paygap[paygap$delay < -366, ]$employer_id))
```

It is a legal requirement for all employers who are required to report and publish their gender pay gap information to accurately report this information. Failing to do this within one year of the snapshot date is unlawful. The Equality and Human Rights Commission has the power to enforce any failure to comply with the regulations. Employers that fail to report on time, or report inaccurate data, will be in breach of the regulations and risk facing enforcement action from the Equality and Human Rights Commission (EHRC), leading to court orders and fines.

Most employers appear submit their data just before their deadline. However 0n 6764 (\~14%) occasions data was submitted late. The data shows that there is evidence of employers submitting data over 1500 days late. As well as being unlawful long delays could have implications for the accuracy of data.

There were 104 occassions where employers appear to have submitted data over a year before their due date - therefore before their snapshot date. This calls into question the validity of this data.

# Uniqueness

```{r uniqueness}

# check for duplication of observations
sum(duplicated(paygap))

# is employer_id a unique identifier
nrow(paygap) / n_distinct(paygap$employer_id)
# no there are nearly 4 times as many observations as employer ids

# visualise 
paygap %>% 
  count(employer_id) %>% 
  ggplot() +
  geom_histogram(aes(n), binwidth = 0.5)

# most employer ids appear to be associated with multiple records 
# is there any evidence of >1 entry by employer in same year
paygap %>% 
  group_by(employer_id, year) %>% 
  count() %>%
    filter(n > 1) %>% 
    nrow()
```

There are no duplicate records in this data set. There are multiple observations per employer id due to data being submitted across multiple years. There is only one observation per employer id:year pair - making this pairing a unique identifier. There were 4 occasions identified in the raw data where employers had entered 2 submissions for the same year. This was dealt with during data cleaning where only the most recent entry was retained.

# Validity

There were a number of areas to explore around validity of the data

Early submission

Bonus percent

Percent difference

Hourly pay quartiles

```{r validity}

# early data submission

paygap %>% 
    filter(delay < -366) %>% 
    group_by(snapshot_date) %>% 
    summarise(
        n = n(),
        min_delay = min(delay),
        mean_delay = mean(delay),
        max_delay = max(delay)
    )

# percent paid a bonus 

paygap %>%
  select(male_bonus_percent, female_bonus_percent) %>%
 summary()

paygap %>% 
    filter(female_bonus_percent > 100)  # reported that 100.4% of females received a bonus

# difference in hourly pay (percent)

paygap %>% 
  select(diff_mean_hourly_percent, diff_median_hourly_percent) %>% 
  summary()

paygap %>% 
  ggplot(aes(y = diff_mean_bonus_percent)) +
  geom_boxplot()

paygap %>% 
  ggplot(aes(y = diff_median_bonus_percent)) +
  geom_boxplot() 
```

### Early submission

It was identified during assessment of timeliness that on 96 occasions employers had submitted gender pay gap data prior to their 'snapshot' date. Further investigation revealed that no employer submitted early more than once and that these were all in 2021 and had a due date 6 months later than usual. This coincides with the covid-19 pandemic and may have been the result of relaxation of due dates for reporting due to this. I feel that these submissions are an accurate reflection of the situation on the snapshot day in 2019.

### Bonus percent

This refers to the percentage of men and women receiving bonus pay. As a percentage no values should be less than 0% or greater than 100%. Only one employer provided invalid results with 100.4% of women reported as being paid a bonus

### Difference in hourly percent

Positive values = male paid \> female. Negative = male paid \< female.

Mean and median may give different perspective on patterns of pay within an organisation.

My be worth exploring where mean and median differ as this implies skewness/outliers

```{r}


## there are some very large percentage differences between males and females
## especially for mean and median bonus percent

### visualise distribution of these
paygap %>% 
  ggplot(aes(y = diff_mean_bonus_percent)) +
  geom_boxplot()

paygap %>% 
  ggplot(aes(y = diff_median_bonus_percent)) +
  geom_boxplot() 

### View data
paygap %>% 
  arrange(diff_mean_bonus_percent) %>% 
  head(20) %>% view

paygap %>% 
  arrange(diff_median_bonus_percent) %>% 
  head(20) %>% view

# these extremes may be possible values especially if bonuses are infrequent & 
# uncommon e.g. executive bonus 
# TO DO: may be an area to explore later

### hourly pay quartiles ----
paygap %>% 
  select(contains('quartile')) %>% 
  summary()

# these are percentages and all are valid ie. between 0-100%

# TO DO: check if male + female = 100% for each metric
```
