---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(here)
```

```{r load data}
paygap_long <- readRDS(here("gender_paygap/data/processed/paygap_tidy.rda"))
paygap <- readRDS(here("gender_paygap/data/processed/paygap_clean.rda"))
```

Describe data here + produce codebooks

```{r}
paygap %>% 
    map_df(class)
```

# Univariate analysis

## Categorical variables

```{r}

paygap %>% 
  count(employer_size)

paygap %>% 
  count(employer_size) %>% 
  ggplot() +
  geom_col(aes(x = employer_size, y = n))
```

Most frequent employer size is 250-499. Increasing employer size appears to be associated with decreasing frequency.

## Discrete numeric

```{r}
paygap %>% 
  count(year)

paygap %>% 
  count(year) %>% 
  ggplot() +
  geom_col(aes(x = year, y = n)) 

```

There are similar number of observations for each year at around 10200-10500. However there is a dip in 2019 to around 6200, matching findings regarding implicit missing values, likely to be pandemic related.

## Continuous numeric

### Percent difference in hourly pay

```{r}
# summary statistics
paygap_long %>% 
  filter(
    sex == 'difference' &
      metric %in% c('median_hourly_percent', 'mean_hourly_percent')
  ) %>%
  group_by(metric) %>% 
  summarise(
    min = min(value),
    median = median(value),
    mean = mean(value),
    max = max(value),
    sd = sd(value))

# visualise distribution

## histogram
paygap_long %>% 
  filter(
    sex == 'difference' &
      metric %in% c('median_hourly_percent', 'mean_hourly_percent')
  ) %>% 
  ggplot() +
  geom_histogram(aes(value), binwidth = 5) +
  facet_wrap(~ metric, ncol = 1)

## boxplot
paygap_long %>%
  filter(
    sex == 'difference' &
      metric %in% c('median_hourly_percent', 'mean_hourly_percent')
  ) %>% 
  ggplot() +
  geom_boxplot(aes(x = metric, y = value), alpha = 0.2)

## in view of extreme outliers then median may be most appropriate method to 
## measure the location of centre REVIEW this
```

### Percent difference in bonus pay

```{r}
# summary statistics
paygap_long %>% 
  drop_na(value) %>%  
  filter(
    sex == 'difference' &
      metric %in% c('median_bonus_percent', 'mean_bonus_percent')
  ) %>%
  group_by(metric) %>% 
  summarise(
    min = min(value),
    median = median(value),
    mean = mean(value),
    max = max(value),
    sd = sd(value))

# graphically

## histograms
paygap_long %>% 
  drop_na(value) %>%  
  filter(
    sex == 'difference' &
      metric %in% c('median_bonus_percent', 'mean_bonus_percent')
  ) %>%
  ggplot() +
  geom_histogram(aes(value), binwidth = 1000) +
  facet_wrap(~ metric, ncol = 1)

## boxplot
paygap_long %>% 
  drop_na(value) %>%  
  filter(
    sex == 'difference' &
      metric %in% c('median_bonus_percent', 'mean_bonus_percent')
  ) %>%
  ggplot() +
  geom_boxplot(aes(x = metric, y = value))
```

### Quartiles for hourly pay

```{r}

# numerically
paygap_long %>% 
  drop_na(value) %>% 
  filter(
    sex %in% c('male', 'female') &
      metric != 'bonus_percent') %>%
  group_by(metric, sex) %>% 
  summarise(
    min = min(value),
    median = median(value),
    mean = mean(value),
    max = max(value),
    sd = sd(value))

# graphically

## histograms
paygap_long %>%
  drop_na(value) %>%
  filter(sex %in% c('male', 'female') &
           metric != 'bonus_percent') %>%
  mutate(metric = factor(
    metric,
    ordered = TRUE,
    levels = c(
      'lower_quartile',
      'lower_middle_quartile',
      'upper_middle_quartile',
      'top_quartile'
    ),
    labels = c('lower', 'lower_mid', 'upper_mid', 'top')
  )) %>% 
ggplot() +
  geom_histogram(aes(value, y = ..density..), binwidth = 10) +
  facet_grid(rows = vars(sex), cols = vars(metric))

## boxplots
paygap_long %>%
  drop_na(value) %>%
  filter(sex %in% c('male', 'female') &
           metric != 'bonus_percent') %>%
  mutate(metric = factor(
    metric,
    ordered = TRUE,
    levels = c(
      'lower_quartile',
      'lower_middle_quartile',
      'upper_middle_quartile',
      'top_quartile'
    ),
    labels = c('lower', 'lower_mid', 'upper_mid', 'top')
  )) %>% 
ggplot() +
  geom_boxplot(aes(y = value)) +
  facet_grid(cols = vars(sex), rows = vars(fct_rev(metric)))
```

### Males/Females paid bonus

```{r}

# numeric
paygap_long %>% 
  drop_na(value) %>% 
  filter(
    sex %in% c('male', 'female') &
      metric == 'bonus_percent') %>%
  group_by(metric, sex) %>% 
  summarise(
    min = min(value),
    median = median(value),
    mean = mean(value),
    max = max(value),
    sd = sd(value))

# graphically

## histograms
paygap_long %>% 
  drop_na(value) %>% 
  filter(
    sex %in% c('male', 'female') &
      metric == 'bonus_percent') %>% 
  ggplot() +
  geom_histogram(aes(value), binwidth = 5) +
  facet_wrap(~ sex, ncol = 1)

## boxplots
paygap_long %>% 
  drop_na(value) %>% 
  filter(
    sex %in% c('male', 'female') &
      metric == 'bonus_percent') %>% 
  ggplot() +
  geom_boxplot(aes(value)) +
  facet_wrap(~ sex, ncol = 1)

```

# Bivariate analysis

## Categorical vs Discrete numeric

### employer size vs year

```{r}
# cross tabulation
paygap %>% 
  xtabs(~ employer_size + year, data = .)

year_size <- 
  paygap %>% 
  xtabs(~ employer_size + year, data = .) %>% 
  prop.table(margin = 2) %>% 
  round(2) %>% 
  as_tibble() %>%
  mutate(employer_size =
           factor(
             employer_size,
             ordered = TRUE,
             levels = c(
               "250 to 499",
               "500 to 999",
               "1000 to 4999",
               "5000 to 19,999",
               "20,000 or more"
             )
           ),
         year = as.integer(year))
  

year_size %>%
  ggplot() +
  geom_col(aes(
    x = year_due,
    y = n,
    fill = fct_rev(employer_size)), 
    position = 'fill')+
  scale_fill_discrete()

year_size %>% 
  ggplot(aes(x = year, y = n, color = employer_size)) +
  geom_point() +
  geom_line() +
  scale_color_discrete()
  

```

```{r}
## ended up with bivariate analysis

paygap_long %>%
  drop_na(value) %>%
  filter(sex %in% c('male', 'female') &
           metric != 'bonus_percent') %>%
  group_by(metric, sex) %>%
  summarise(median = median(value)) %>%
  mutate(quartile = factor(
    metric,
    ordered = TRUE,
    levels = c(
      'lower_quartile',
      'lower_middle_quartile',
      'upper_middle_quartile',
      'top_quartile'
    ),
    labels = c('lower', 'lower_mid', 'upper_mid', 'top')
  )) %>% 
  ggplot() +
  geom_col(aes(x = quartile, y = median, fill = sex), position = 'stack')


```
